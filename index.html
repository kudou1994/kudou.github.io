<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸèµµå®‡çš„é©¬å¹´ç¥ç¦</title>
    <style>
        :root { --primary-red: #d93025; --gold: #f9c74f; --bg-color: #fff5f5; }
        body { font-family: 'Microsoft YaHei', sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { max-width: 800px; width: 100%; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; text-align: center; border: 2px solid var(--primary-red); }
        h1 { color: var(--primary-red); }
        .btn { background-color: var(--primary-red); color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 50px; cursor: pointer; margin: 20px 0; }
        .btn:hover { background-color: #c52b1f; }
        .hidden { display: none !important; }
        .user-info { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; }
        .input-area { margin: 20px 0; }
        .input-group { display: flex; gap: 10px; justify-content: center; }
        input[type="text"] { padding: 12px 20px; border: 2px solid #ddd; border-radius: 50px; font-size: 16px; width: 300px; }
        .danmu-container { height: 300px; background: #000; border-radius: 10px; overflow: hidden; position: relative; color: white; margin-top: 20px; border: 4px solid var(--gold); }
        .danmu-track { position: absolute; white-space: nowrap; font-size: 18px; font-weight: bold; }
        .debug-box { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px; text-align: left; max-height: 200px; overflow-y: auto; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ 2026 é©¬å¹´å¤§å‰ ğŸ</h1>
        
        <!-- ç™»å½•æŒ‰é’® - ä½¿ç”¨å†…è” onclick ç¡®ä¿èƒ½è§¦å‘ -->
        <div id="login-section">
            <p>ğŸ’¬ å‘é€å¼¹å¹•å‰è¯·å…ˆç™»å½• GitHub</p>
            <button class="btn" onclick="doLogin()">ğŸ” ä½¿ç”¨ GitHub ç™»å½•</button>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯ - ç™»å½•åæ˜¾ç¤º -->
        <div id="user-section" class="user-info hidden">
            <img id="user-avatar" class="avatar" src="" alt="">
            <span id="user-name"></span>
            <button class="btn" onclick="doLogout()" style="padding: 8px 15px; font-size: 14px;">é€€å‡º</button>
        </div>

        <!-- å¼¹å¹•è¾“å…¥æ¡† - ç™»å½•åæ˜¾ç¤º -->
        <div id="input-section" class="input-area hidden">
            <div class="input-group">
                <input type="text" id="danmu-input" placeholder="è¾“å…¥ç¥ç¦è¯­..." maxlength="50">
                <button class="btn" onclick="sendDanmu()">å‘é€ ğŸš€</button>
            </div>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="debug-box" id="debug-box">
            <strong>ğŸ” è°ƒè¯•æ—¥å¿—ï¼š</strong>
            <div id="logs"></div>
        </div>

        <!-- å¼¹å¹•å±•ç¤ºåŒº -->
        <div class="danmu-container" id="danmu-screen">
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#aaa;">æ­£åœ¨åŠ è½½å¼¹å¹•...</div>
        </div>
    </div>

    <script>
        // ============ é…ç½®åŒºåŸŸ ============
        const CONFIG = {
            clientId: 'Ov23liuXYxHOmaUSKNUx',
            owner: 'kudou1994',  // âš ï¸ æ”¹æˆä½ çš„ç”¨æˆ·å
            repo: 'kudou.github.io'          // âš ï¸ æ”¹æˆä½ çš„ä»“åº“å
        };
        // =================================

        let token = null;
        let user = null;

        // æ—¥å¿—å‡½æ•°
        function log(msg, type = '') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${time}] ${msg}`;
            document.getElementById('logs').prepend(div);
            console.log('[Danmu]', msg);
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.onload = function() {
            log('=== é¡µé¢åŠ è½½å®Œæˆ ===');
            
            // æ£€æŸ¥ URL æ˜¯å¦æœ‰ token
            const hash = window.location.hash.substring(1);
            log(`URL Hash: ${hash || '(ç©º)'}`);
            
            if (hash) {
                const params = new URLSearchParams(hash);
                const accessToken = params.get('access_token');
                if (accessToken) {
                    token = accessToken;
                    localStorage.setItem('github_token', accessToken);
                    log('âœ… Token å·²ä¿å­˜', 'success');
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }
            
            // ä»æœ¬åœ°å­˜å‚¨æ¢å¤ token
            if (!token) {
                token = localStorage.getItem('github_token');
                if (token) log('ä»æœ¬åœ°æ¢å¤ Token');
            }
            
            // å¦‚æœæœ‰ tokenï¼Œè·å–ç”¨æˆ·ä¿¡æ¯å¹¶æ›´æ–° UI
            if (token) {
                fetchUserInfo();
            } else {
                log('æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æŒ‰é’®');
            }
            
            // åŠ è½½å¼¹å¹•
            loadDanmus();
        };

        // ç™»å½•å‡½æ•°ï¼ˆå†…è”è°ƒç”¨ï¼‰
        function doLogin() {
            log('ğŸ”˜ ç‚¹å‡»ç™»å½•æŒ‰é’®');
            
            // æ£€æŸ¥é…ç½®
            if (CONFIG.owner === 'YOUR_GITHUB_USERNAME') {
                alert('âš ï¸ è¯·å…ˆåœ¨ä»£ç ä¸­ä¿®æ”¹ CONFIG.owner å’Œ CONFIG.repoï¼');
                log('é…ç½®æœªä¿®æ”¹', 'error');
                return;
            }
            
            const redirectUri = window.location.href.split('#')[0];
            const url = `https://github.com/login/oauth/authorize?client_id=${CONFIG.clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=public_repo&response_type=token`;
            
            log(`è·³è½¬è‡³: ${url.substring(0, 80)}...`);
            window.location.href = url;
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        async function fetchUserInfo() {
            try {
                log('æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...');
                const res = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (res.ok) {
                    user = await res.json();
                    log(`âœ… ç”¨æˆ·: ${user.login}`, 'success');
                    updateUI(true);
                } else {
                    log(`Token æ— æ•ˆ: ${res.status}`, 'error');
                    localStorage.removeItem('github_token');
                    token = null;
                    updateUI(false);
                }
            } catch (e) {
                log(`é”™è¯¯: ${e.message}`, 'error');
                updateUI(false);
            }
        }

        // æ›´æ–° UI
        function updateUI(isLoggedIn) {
            const loginSec = document.getElementById('login-section');
            const userSec = document.getElementById('user-section');
            const inputSec = document.getElementById('input-section');
            
            if (isLoggedIn && user) {
                loginSec.classList.add('hidden');
                userSec.classList.remove('hidden');
                inputSec.classList.remove('hidden');
                document.getElementById('user-avatar').src = user.avatar_url;
                document.getElementById('user-name').textContent = user.login;
                log('UI å·²æ›´æ–°ä¸ºç™»å½•çŠ¶æ€', 'success');
            } else {
                loginSec.classList.remove('hidden');
                userSec.classList.add('hidden');
                inputSec.classList.add('hidden');
                log('UI å·²æ›´æ–°ä¸ºæœªç™»å½•çŠ¶æ€');
            }
        }

        // é€€å‡ºç™»å½•
        function doLogout() {
            log('ç”¨æˆ·é€€å‡º');
            localStorage.removeItem('github_token');
            token = null;
            user = null;
            location.reload();
        }

        // å‘é€å¼¹å¹•
        async function sendDanmu() {
            const input = document.getElementById('danmu-input');
            const content = input.value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥å†…å®¹');
                return;
            }
            
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            if (CONFIG.owner === 'YOUR_GITHUB_USERNAME') {
                alert('âš ï¸ è¯·é…ç½® CONFIG.owner å’Œ CONFIG.repoï¼');
                return;
            }
            
            log(`å‘é€å¼¹å¹•: ${content}`);
            
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/issues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: `ğŸ ç¥ç¦: ${user.login}`,
                        body: `> ${content}`,
                        labels: ['danmu']
                    })
                });
                
                if (res.ok) {
                    alert('âœ… å‘é€æˆåŠŸï¼');
                    input.value = '';
                    loadDanmus();
                } else {
                    const err = await res.json();
                    alert(`å‘é€å¤±è´¥: ${err.message}`);
                    log(`å‘é€å¤±è´¥: ${err.message}`, 'error');
                }
            } catch (e) {
                alert(`é”™è¯¯: ${e.message}`);
                log(`å‘é€é”™è¯¯: ${e.message}`, 'error');
            }
        }

        // åŠ è½½å¼¹å¹•
        async function loadDanmus() {
            if (CONFIG.owner === 'YOUR_GITHUB_USERNAME') {
                document.getElementById('danmu-screen').innerHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:red;">âš ï¸ è¯·é…ç½® CONFIG</div>';
                return;
            }
            
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/issues?labels=danmu&state=open&per_page=20`);
                if (res.ok) {
                    const issues = await res.json();
                    log(`åŠ è½½ ${issues.length} æ¡å¼¹å¹•`);
                    renderDanmus(issues);
                } else {
                    log(`åŠ è½½å¤±è´¥: ${res.status}`, 'error');
                }
            } catch (e) {
                log(`åŠ è½½é”™è¯¯: ${e.message}`, 'error');
            }
        }

        // æ¸²æŸ“å¼¹å¹•
        function renderDanmus(issues) {
            const screen = document.getElementById('danmu-screen');
            screen.innerHTML = '';
            
            if (issues.length === 0) {
                screen.innerHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#aaa;">æš‚æ— å¼¹å¹•</div>';
                return;
            }
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            if (!document.getElementById('danmu-css')) {
                const style = document.createElement('style');
                style.id = 'danmu-css';
                style.textContent = `@keyframes moveLeft { from { transform: translateX(${screen.offsetWidth}px); } to { transform: translateX(-100%); } }`;
                document.head.appendChild(style);
            }
            
            issues.forEach((issue, i) => {
                const div = document.createElement('div');
                div.className = 'danmu-track';
                div.textContent = `${issue.user.login}: ${issue.body.replace('> ', '')}`;
                div.style.top = `${10 + Math.random() * 80}%`;
                div.style.animation = `moveLeft ${10 + Math.random() * 10}s linear ${i * 2}s infinite`;
                screen.appendChild(div);
            });
        }
    </script>
</body>
</html>
