<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµµå®‡çš„é©¬å¹´ç¥ç¦</title>
    <style>
        /* --- å…¨å±€æ ·å¼ä¸ç§»åŠ¨ç«¯é€‚é… --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»šåŠ¨æ¡ */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- ç²’å­èƒŒæ™¯å®¹å™¨ --- */
        #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        /* --- ä¸»è¦å†…å®¹åŒºåŸŸ --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 10;
        }

        /* --- ç¥ç¦è¯­ä¸»å¡ç‰‡ --- */
        .blessing-card {
            background: rgba(25, 25, 35, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px 20px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }
        .blessing-card h1 {
            font-size: 2.2em;
            margin-bottom: 20px;
            color: #f8c300; /* é©¬å¹´é‡‘è‰² */
            text-shadow: 0 0 10px rgba(248, 195, 0, 0.5);
        }
        .blessing-card p {
            font-size: 1.1em;
            line-height: 1.8;
            margin: 10px 0;
            color: #e0e0ff;
        }

        /* --- ç™»å½•/å¼¹å¹•æ§åˆ¶åŒº --- */
        .dandan-control {
            width: 90%;
            max-width: 500px;
        }
        .login-prompt {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.95em;
            color: #a0a0ff;
        }
        .auth-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #loginBtn {
            background: linear-gradient(45deg, #ff8c00, #ff0080);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(255, 0, 128, 0.4);
        }
        #loginBtn:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 20px rgba(255, 0, 128, 0.6);
        }
        .danmaku-input-area {
            display: none; /* é»˜è®¤éšè— */
            flex-direction: row;
            gap: 10px;
        }
        #danmakuInput {
            flex: 1;
            padding: 14px;
            border-radius: 50px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
        }
        #danmakuInput::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        #sendDanmakuBtn {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 50px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        #sendDanmakuBtn:hover {
            opacity: 0.9;
        }

        /* --- å¼¹å¹•å®¹å™¨ --- */
        #danmakuContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* è®©å¼¹å¹•ä¸é˜»æŒ¡é¼ æ ‡ç‚¹å‡» */
            z-index: 5;
            overflow: hidden;
        }
        .danmaku-item {
            position: absolute;
            right: -400px; /* åˆå§‹ä½ç½®åœ¨å±å¹•å¤–å³ä¾§ */
            white-space: nowrap;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            font-size: 1em;
            color: #fff;
            user-select: none;
            animation: danmakuMove linear;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            border-left: 3px solid #f8c300;
        }
        @keyframes danmakuMove {
            from { transform: translateX(0); }
            to { transform: translateX(-100vw); }
        }

        /* --- åŠ è½½åŠ¨ç”» --- */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- ç²’å­èƒŒæ™¯ -->
    <div id="particles-js"></div>

    <!-- å¼¹å¹•å®¹å™¨ -->
    <div id="danmakuContainer"></div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content">
        <div class="blessing-card">
            <h1>ğŸ é©¬å¹´é©¾åˆ°ï¼ŒAI åŠ æŒï¼</h1>
            <p>èµµå®‡åœ¨è¿™é‡Œç¥æ‚¨ï¼š</p>
            <p>âœ¨ AI åˆ†çç¢ï¼Œé—²æ—¶ä¼´å®¶äººã€‚</p>
            <p>âœ¨ æ™ºèƒ½å¯æ¢¦æƒ³ï¼Œåˆ›æ„ä»»é©°é£ã€‚</p>
            <p>âœ¨ äººæœºå…±åä½œï¼Œæ™ºå¼•å‘ä¹¾å¤ï¼</p>
        </div>

        <div class="dandan-control">
            <div class="login-prompt">
                ğŸ’¬ æ¬¢è¿ç•™ä¸‹æ‚¨çš„ç¥ç¦ï¼è¯·å…ˆç™»å½• GitHub è´¦å·ä»¥å‘é€å¼¹å¹•ã€‚
            </div>
            <div class="auth-section">
                <button id="loginBtn">>Login with GitHub</button>
                <div class="danmaku-input-area">
                    <input type="text" id="danmakuInput" placeholder="è¾“å…¥æ‚¨çš„ç¥ç¦è¯­...">
                    <button id="sendDanmakuBtn">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Particles.js CDN -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // --- é…ç½®ä¿¡æ¯ ---
        const GITHUB_CONFIG = {
            clientId: 'Ov23liuXYxHOmaUSKNUx',
            owner: 'kudou1994',
            repo: 'kudou.github.io'
        };
        const REDIRECT_URI = window.location.href.split('#')[0]; // å½“å‰é¡µé¢URLä½œä¸ºé‡å®šå‘åœ°å€
        const AUTH_URL = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CONFIG.clientId}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=public_repo`;

        // DOMå…ƒç´ 
        const loginBtn = document.getElementById('loginBtn');
        const danmakuInputArea = document.querySelector('.danmaku-input-area');
        const danmakuInput = document.getElementById('danmakuInput');
        const sendDanmakuBtn = document.getElementById('sendDanmakuBtn');
        const danmakuContainer = document.getElementById('danmakuContainer');

        let accessToken = null;

        // 1. åˆå§‹åŒ–ç²’å­èƒŒæ™¯
        particlesJS("particles-js", {
            "particles": {
                "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
                "color": { "value": "#ffffff" },
                "shape": { "type": "circle" },
                "opacity": { "value": 0.5, "random": true },
                "size": { "value": 3, "random": true },
                "line_linked": {
                    "enable": true,
                    "distance": 150,
                    "color": "#ffffff",
                    "opacity": 0.2,
                    "width": 1
                },
                "move": {
                    "enable": true,
                    "speed": 2,
                    "direction": "none",
                    "random": true,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": { "enable": true, "mode": "grab" },
                    "onclick": { "enable": true, "mode": "push" },
                    "resize": true
                }
            }
        });

        // 2. æ£€æŸ¥ URL æ˜¯å¦åŒ…å«æˆæƒç  (code)
        function checkForAuthCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                // æ¸…é™¤URLä¸­çš„codeå‚æ•°ï¼Œé¿å…é‡å¤å¤„ç†
                window.history.replaceState({}, document.title, window.location.pathname);

                console.log('è·å–åˆ°æˆæƒç :', code);
                exchangeCodeForToken(code);
            } else {
                // å¦‚æœæ²¡æœ‰codeï¼Œåˆ™æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„token
                accessToken = localStorage.getItem('github_access_token');
                if (accessToken) {
                    console.log('ä»æœ¬åœ°å­˜å‚¨æ¢å¤ Token');
                    onLoginSuccess();
                } else {
                    console.log('æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€');
                }
            }
        }

        // 3. ä½¿ç”¨æˆæƒç æ¢å– Access Token
        async function exchangeCodeForToken(code) {
            try {
                const response = await fetch(`https://kudou1994-auth-server.vercel.app/api/auth/callback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        client_id: GITHUB_CONFIG.clientId,
                        redirect_uri: REDIRECT_URI
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Tokenäº¤æ¢å¤±è´¥: ${response.statusText}`);
                }

                const data = await response.json();
                accessToken = data.access_token;
                
                if (accessToken) {
                    localStorage.setItem('github_access_token', accessToken);
                    console.log('Token è·å–æˆåŠŸå¹¶å·²å­˜å‚¨');
                    onLoginSuccess();
                } else {
                    alert('è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                    console.error('Token ä¸ºç©ºæˆ–æ— æ•ˆ');
                }
            } catch (error) {
                console.error('äº¤æ¢Tokenæ—¶å‡ºé”™:', error);
                alert('ç™»å½•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
            }
        }

        // 4. ç™»å½•æˆåŠŸåçš„ UI æ›´æ–°
        function onLoginSuccess() {
            loginBtn.style.display = 'none';
            danmakuInputArea.style.display = 'flex';
        }

        // 5. ç™»å½•æŒ‰é’®äº‹ä»¶
        loginBtn.addEventListener('click', () => {
            window.location.href = AUTH_URL;
        });

        // 6. å‘é€å¼¹å¹•äº‹ä»¶
        sendDanmakuBtn.addEventListener('click', sendDanmaku);
        danmakuInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendDanmaku();
            }
        });

        async function sendDanmaku() {
            const message = danmakuInput.value.trim();
            if (!message) return;
            if (!accessToken) {
                alert('è¯·å…ˆç™»å½•ï¼');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const originalText = sendDanmakuBtn.textContent;
            sendDanmakuBtn.textContent = 'å‘é€ä¸­...';
            sendDanmakuBtn.disabled = true;

            try {
                // å°†å¼¹å¹•å†…å®¹ä½œä¸ºè¯„è®ºå‘å¸ƒåˆ°æŒ‡å®š Issue
                const issueNumber = 2; // æŒ‡å®šç”¨äºå¼¹å¹•çš„ Issue å·
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/issues/${issueNumber}/comments`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                    },
                    body: JSON.stringify({ body: message })
                });

                if (response.ok) {
                    console.log('å¼¹å¹•å‘é€æˆåŠŸ');
                    danmakuInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                    // ç«‹å³åœ¨å‰ç«¯æ˜¾ç¤ºè¿™æ¡å¼¹å¹•
                    createAndAppendDanmaku(message);
                } else {
                    const errorData = await response.json();
                    console.error('å‘é€å¤±è´¥:', errorData);
                    alert(`å‘é€å¤±è´¥: ${errorData.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('ç½‘ç»œé”™è¯¯:', error);
                alert('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                sendDanmakuBtn.textContent = originalText;
                sendDanmakuBtn.disabled = false;
            }
        }

        // 7. åˆ›å»ºå¹¶æ·»åŠ å¼¹å¹•DOMå…ƒç´ 
        function createAndAppendDanmaku(text) {
            const danmaku = document.createElement('div');
            danmaku.className = 'danmaku-item';
            danmaku.textContent = text;

            // éšæœºè®¾ç½®å‚ç›´ä½ç½®
            const topOffset = Math.random() * (window.innerHeight * 0.8);
            danmaku.style.top = `${topOffset}px`;

            // éšæœºåŠ¨ç”»æŒç»­æ—¶é—´ (10-20ç§’)ï¼Œæ¨¡æ‹Ÿä¸åŒé€Ÿåº¦
            const duration = 10 + Math.random() * 10;
            d
