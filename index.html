<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é©¬å¹´ç¥ç¦ | èµµå®‡ç¥æ‚¨ AI åŠ æŒ</title>
    <style>
        /* --- å…¨å±€æ ·å¼ä¸ç§»åŠ¨ç«¯é€‚é… --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»šåŠ¨æ¡ */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- ç²’å­èƒŒæ™¯å®¹å™¨ --- */
        #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        /* --- ä¸»è¦å†…å®¹åŒºåŸŸ --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 10;
        }

        /* --- ç¥ç¦è¯­ä¸»å¡ç‰‡ --- */
        .blessing-card {
            background: rgba(25, 25, 35, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px 20px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }
        .blessing-card h1 {
            font-size: 2.2em;
            margin-bottom: 20px;
            color: #f8c300; /* é©¬å¹´é‡‘è‰² */
            text-shadow: 0 0 10px rgba(248, 195, 0, 0.5);
        }
        .blessing-card p {
            font-size: 1.1em;
            line-height: 1.8;
            margin: 10px 0;
            color: #e0e0ff;
        }

        /* --- ç™»å½•/å¼¹å¹•æ§åˆ¶åŒº --- */
        .dandan-control {
            width: 90%;
            max-width: 500px;
        }
        .login-prompt {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.95em;
            color: #a0a0ff;
        }
        .auth-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #loginBtn {
            background: linear-gradient(45deg, #ff8c00, #ff0080);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(255, 0, 128, 0.4);
        }
        #loginBtn:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 20px rgba(255, 0, 128, 0.6);
        }
        .danmaku-input-area {
            display: none; /* é»˜è®¤éšè— */
            flex-direction: row;
            gap: 10px;
        }
        #danmakuInput {
            flex: 1;
            padding: 14px;
            border-radius: 50px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
        }
        #danmakuInput::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        #sendDanmakuBtn {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 50px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        #sendDanmakuBtn:hover {
            opacity: 0.9;
        }
        
        /* --- æ–°å¢ï¼šToken è¾“å…¥å’ŒéªŒè¯åŒº --- */
        .token-section {
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        .token-prompt {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9em;
            color: #a0a0ff;
            line-height: 1.6;
        }
        #tokenInput {
            padding: 14px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
        }
        #tokenInput::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        #verifyTokenBtn {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        #verifyTokenBtn:hover {
            opacity: 0.9;
        }

        /* --- å¼¹å¹•å®¹å™¨ --- */
        #danmakuContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* è®©å¼¹å¹•ä¸é˜»æŒ¡é¼ æ ‡ç‚¹å‡» */
            z-index: 5;
            overflow: hidden;
        }
        .danmaku-item {
            position: absolute;
            right: -400px; /* åˆå§‹ä½ç½®åœ¨å±å¹•å¤–å³ä¾§ */
            white-space: nowrap;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            font-size: 1em;
            color: #fff;
            user-select: none;
            animation: danmakuMove linear;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            border-left: 3px solid #f8c300;
        }
        @keyframes danmakuMove {
            from { transform: translateX(0); }
            to { transform: translateX(-100vw); }
        }

        /* --- åŠ è½½åŠ¨ç”» --- */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- æ–°å¢ï¼šå¤åˆ¶é“¾æ¥æç¤ºæ¡†æ ·å¼ --- */
        .copy-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none; /* é»˜è®¤éšè— */
            text-align: center;
            max-width: 90%;
        }
        .copy-prompt input {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background: #333;
            color: white;
        }
        .copy-prompt button {
            margin-top: 10px;
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- ç²’å­èƒŒæ™¯ -->
    <div id="particles-js"></div>

    <!-- å¼¹å¹•å®¹å™¨ -->
    <div id="danmakuContainer"></div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content">
        <div class="blessing-card">
            <h1>ğŸ é©¬å¹´é©¾åˆ°ï¼ŒAI åŠ æŒï¼</h1>
            <p>èµµå®‡åœ¨è¿™é‡Œç¥æ‚¨ï¼š</p>
            <p>âœ¨ AI åˆ†çç¢ï¼Œé—²æ—¶ä¼´å®¶äººã€‚</p>
            <p>âœ¨ æ™ºèƒ½å¯æ¢¦æƒ³ï¼Œåˆ›æ„ä»»é©°é£ã€‚</p>
            <p>âœ¨ äººæœºå…±åä½œï¼Œæ™ºå¼•å‘ä¹¾å¤ï¼</p>
        </div>

        <div class="dandan-control">
            <div class="login-prompt">
                ğŸ’¬ æ¬¢è¿ç•™ä¸‹æ‚¨çš„ç¥ç¦ï¼è¯·å…ˆç™»å½• GitHub è´¦å·ä»¥å‘é€å¼¹å¹•ã€‚
            </div>
            <div class="auth-section">
                <button id="loginBtn">>Login with GitHub</button>
                
                <!-- æ–°å¢ï¼šToken è¾“å…¥å’ŒéªŒè¯åŒº -->
                <div class="token-section">
                    <div class="token-prompt">
                        <strong>é‡è¦æç¤º:</strong><br>
                        1. æ‚¨å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ GitHub æˆæƒé¡µã€‚<br>
                        2. å®Œæˆæˆæƒåï¼Œé¡µé¢ä¼šè·³è½¬åˆ°ä¸€ä¸ªé”™è¯¯åœ°å€ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰ã€‚<br>
                        3. è¯·å¤åˆ¶æµè§ˆå™¨åœ°å€æ ä¸­ <code>access_token=</code> åé¢çš„é‚£ä¸²å­—ç¬¦ã€‚<br>
                        4. å°†å…¶ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†ï¼Œç‚¹å‡»éªŒè¯å³å¯å®Œæˆç™»å½•ã€‚
                    </div>
                    <input type="password" id="tokenInput" placeholder="ç²˜è´´æ‚¨çš„ access_token ...">
                    <button id="verifyTokenBtn">éªŒè¯ Token å¹¶ç™»å½•</button>
                </div>
                
                <div class="danmaku-input-area">
                    <input type="text" id="danmakuInput" placeholder="è¾“å…¥æ‚¨çš„ç¥ç¦è¯­...">
                    <button id="sendDanmakuBtn">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤åˆ¶é“¾æ¥æç¤ºæ¡† -->
    <div id="copyPrompt" class="copy-prompt">
        <p>æœªèƒ½è‡ªåŠ¨è·³è½¬åˆ° GitHub ç™»å½•é¡µï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä¸‹æ–¹é“¾æ¥å¹¶åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ã€‚</p>
        <input type="text" id="authUrlInput" readonly>
        <button onclick="copyAuthUrl()">å¤åˆ¶é“¾æ¥</button>
    </div>

    <!-- Particles.js CDN -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // --- é…ç½®ä¿¡æ¯ ---
        const GITHUB_CONFIG = {
            clientId: 'Ov23liuXYxHOmaUSKNUx',
            owner: 'kudou1994',
            repo: 'kudou.github.io'
        };
        const REDIRECT_URI = window.location.href.split('#')[0];
        // ä¿®æ”¹æˆæƒURLï¼Œä½¿å…¶ç›´æ¥è¿”å› access_token (éšå¼æˆæƒï¼Œé€‚ç”¨äºçº¯å‰ç«¯)
        const AUTH_URL = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CONFIG.clientId}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=public_repo&response_type=token`;

        // DOMå…ƒç´ 
        const loginBtn = document.getElementById('loginBtn');
        const tokenSection = document.querySelector('.token-section');
        const tokenInput = document.getElementById('tokenInput');
        const verifyTokenBtn = document.getElementById('verifyTokenBtn');
        const danmakuInputArea = document.querySelector('.danmaku-input-area');
        const danmakuInput = document.getElementById('danmakuInput');
        const sendDanmakuBtn = document.getElementById('sendDanmakuBtn');
        const danmakuContainer = document.getElementById('danmakuContainer');
        const copyPrompt = document.getElementById('copyPrompt');
        const authUrlInput = document.getElementById('authUrlInput');

        let accessToken = null;

        // 1. åˆå§‹åŒ–ç²’å­èƒŒæ™¯
        particlesJS("particles-js", {
            "particles": {
                "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
                "color": { "value": "#ffffff" },
                "shape": { "type": "circle" },
                "opacity": { "value": 0.5, "random": true },
                "size": { "value": 3, "random": true },
                "line_linked": {
                    "enable": true,
                    "distance": 150,
                    "color": "#ffffff",
                    "opacity": 0.2,
                    "width": 1
                },
                "move": {
                    "enable": true,
                    "speed": 2,
                    "direction": "none",
                    "random": true,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": { "enable": true, "mode": "grab" },
                    "onclick": { "enable": true, "mode": "push" },
                    "resize": true
                }
            }
        });

        // 2. æ£€æŸ¥ URL æ˜¯å¦åŒ…å« access_token (éšå¼æˆæƒè¿”å›)
        function checkForAccessToken() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            
            if (token) {
                // æ¸…é™¤URLä¸­çš„hashéƒ¨åˆ†ï¼Œä½¿åœ°å€æ æ›´å¹²å‡€
                window.location.hash = '';
                console.log('è·å–åˆ° access_token:', token);
                // ç›´æ¥ä½¿ç”¨è·å–åˆ°çš„token
                accessToken = token;
                localStorage.setItem('github_access_token', accessToken);
                onLoginSuccess();
            } else {
                // å¦‚æœæ²¡æœ‰hashä¸­çš„tokenï¼Œåˆ™æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„token
                accessToken = localStorage.getItem('github_access_token');
                if (accessToken) {
                    console.log('ä»æœ¬åœ°å­˜å‚¨æ¢å¤ Token');
                    onLoginSuccess();
                } else {
                    console.log('æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€');
                }
            }
        }

        // 3. ç™»å½•æˆåŠŸåçš„ UI æ›´æ–°
        function onLoginSuccess() {
            loginBtn.style.display = 'none';
            tokenSection.style.display = 'none';
            danmakuInputArea.style.display = 'flex';
        }

        // 4. ç™»å½•æŒ‰é’®äº‹ä»¶
        loginBtn.addEventListener('click', () => {
            // æ‰“å¼€æ–°çª—å£è¿›è¡Œæˆæƒ
            window.open(AUTH_URL, '_blank');
            // æ˜¾ç¤ºTokenè¾“å…¥åŒº
            tokenSection.style.display = 'flex';
            // éšè—ç™»å½•æŒ‰é’®
            loginBtn.style.display = 'none';
            
            // æç¤ºç”¨æˆ·æ£€æŸ¥æ–°çª—å£
            setTimeout(() => {
                 if (confirm("è¯·åœ¨æ–°æ‰“å¼€çš„æ ‡ç­¾é¡µä¸­å®Œæˆ GitHub æˆæƒã€‚å®Œæˆåï¼Œå°†è¿”å›çš„ access_token ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†ã€‚")) {
                    showCopyPrompt();
                }
            }, 1000);
        });

        // 5. éªŒè¯TokenæŒ‰é’®äº‹ä»¶ (æ–°åŠŸèƒ½)
        verifyTokenBtn.addEventListener('click', async () => {
            const token = tokenInput.value.trim();
            if (!token) {
                alert('è¯·è¾“å…¥ access_tokenã€‚');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const originalText = verifyTokenBtn.textContent;
            verifyTokenBtn.textContent = 'éªŒè¯ä¸­...';
            verifyTokenBtn.disabled = true;

            try {
                // å°è¯•ç”¨è¿™ä¸ªtokenè®¿é—®GitHub APIæ¥éªŒè¯å…¶æœ‰æ•ˆæ€§
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    console.log('Token éªŒè¯æˆåŠŸï¼Œç”¨æˆ·:', userData.login);
                    accessToken = token;
                    localStorage.setItem('github_access_token', accessToken);
                    onLoginSuccess(); // æ›´æ–°UI
                } else {
                    const errorData = await response.json();
                    console.error('Token éªŒè¯å¤±è´¥:', errorData);
                    alert(`Token éªŒè¯å¤±è´¥: ${errorData.message || 'æ— æ•ˆçš„ Token æˆ–æƒé™ä¸è¶³'}`);
                }
            } catch (error) {
                console.error('éªŒè¯Tokenæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:', error);
                alert('éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯•ã€‚');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                verifyTokenBtn.textContent = originalText;
                verifyTokenBtn.disabled = false;
            }
        });

        // 6. æ˜¾ç¤ºå¤åˆ¶é“¾æ¥æç¤º
        function showCopyPrompt() {
            authUrlInput.value = AUTH_URL;
            copyPrompt.style.display = 'block';
        }

        // 7. å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
        function copyAuthUrl() {
            authUrlInput.select();
            document.execCommand('copy');
            alert('æˆæƒé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            copyPrompt.style.display = 'none';
        }

        // 8. å‘é€å¼¹å¹•äº‹ä»¶
        sendDanmakuBtn.addEventListener('click', sendDanmaku);
        danmakuInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendDanmaku();
            }
        });

        async function sendDanmaku() {
            const message = danmakuInput.value.trim();
            if (!message) return;
            if (!accessToken) {
                alert('è¯·å…ˆç™»å½•ï¼');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const originalText = sendDanmakuBtn.textContent;
            sendDanmakuBtn.textContent = 'å‘é€ä¸­...';
            sendDanmakuBtn.disabled = true;

            try {
                // å°†å¼¹å¹•å†…å®¹ä½œä¸ºè¯„è®ºå‘å¸ƒåˆ°æŒ‡å®š Issue
                const issueNumber = 2; // æŒ‡å®šç”¨äºå¼¹å¹•çš„ Issue å·
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/issues/${issueNumber}/comments`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                    },
                    body: JSON.stringify({ body: message })
                });

                if (response.ok) {
                    console.log('å¼¹å¹•å‘é€æˆåŠŸ');
                    danmakuInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                    // ç«‹å³åœ¨å‰ç«¯æ˜¾ç¤ºè¿™æ¡å¼¹å¹•
                    createAndAppendDanmaku(message);
                } else {
                    const errorData = await response.json();
                    console.error('å‘é€å¤±è´¥:', errorData);
                    alert(`å‘é€å¤±è´¥: ${errorData.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('ç½‘ç»œé”™è¯¯:', error);
                alert('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                sendDanmakuBtn.textContent = originalText;
                sendDanmakuBtn.disabled = false;
            }
        }

        // 9. åˆ›å»ºå¹¶æ·»åŠ å¼¹å¹•DOMå…ƒç´ 
        function createAndAppendDanmaku(text) {
            const danmaku = document.createElement('div');
            danmaku.className = 'danmaku-item';
            danmaku.textContent = text;

            // éšæœºè®¾ç½®å‚ç›´ä½ç½®
            const topOffset = Math.random() * (window.innerHeight * 0.8);
            danmaku.style.top = `${topOffset}px`;

            // éšæœºåŠ¨ç”»æŒç»­æ—¶é—´ (10-20ç§’)ï¼Œæ¨¡æ‹Ÿä¸åŒé€Ÿåº¦
            const duration = 10 + Math.random() * 10;
            danmaku.style.animationDuration = `${duration}s`;

            danmakuContainer.appendChild(danmaku);

            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ ä»¥ä¼˜åŒ–æ€§èƒ½
            setTimeout(() => {
                if (danmaku.parentNode) {
                    danmaku.parentNode.removeChild(danmaku);
                }
            }, duration * 1000);
        }

        // 10. è·å–å¹¶æ˜¾ç¤ºå†å²å¼¹å¹•
        async function loadDanmakus() {
            try {
                // ä»æŒ‡å®š Issue è·å–è¯„è®ºåˆ—è¡¨
                const issueNumber = 2;
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/issues/${issueNumber}/comments`);
                
                if (!response.ok) {
                    if(response.status === 404){
                         console.warn('å¼¹å¹• Issue ä¸å­˜åœ¨ï¼Œæ— æ³•åŠ è½½å†å²å¼¹å¹•ã€‚')
                         return;
                    }
                    throw new Error(`åŠ è½½å¼¹å¹•å¤±è´¥: ${response.statusText}`);
                }

                const comments = await response.json();
                comments.forEach(comment => {
                    // è¿‡æ»¤æ‰å¯èƒ½çš„ç³»ç»Ÿæ¶ˆæ¯æˆ–ç‰¹å®šæ ¼å¼
                    if (comment.body && comment.body.trim().length > 0 && !comment.body.startsWith('***')) {
                        createAndAppendDanmaku(comment.body);
                    }
                });
            } catch (error) {
                console.error('åŠ è½½å†å²å¼¹å¹•æ—¶å‡ºé”™:', error);
            }
        }

        // 11. é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            checkForAccessToken(); // æ£€æŸ¥ç™»å½•çŠ¶æ€ (ä¼˜å…ˆæ£€æŸ¥hashä¸­çš„token)
            loadDanmakus();     // åŠ è½½å†å²å¼¹å¹•
        });

    </script>
</body>
</html>
