<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµµå®‡çš„é©¬å¹´ç¥ç¦</title>
    <!-- å¼¹å¹•åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/danmaku-js@1.0.6/dist/danmaku.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            font-family: 'Microsoft YaHei', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        /* å¼¹å¹•å±‚ */
        #danmaku-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .container {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-width: 600px;
            width: 90%;
            position: relative;
            z-index: 10;
        }

        h1 { color: #d63031; font-size: 2.5em; margin-bottom: 10px; }
        .year { font-size: 1.5em; color: #e17055; font-weight: bold; }
        .blessing {
            font-size: 1.2em; line-height: 1.8; color: #2d3436;
            margin: 20px 0; white-space: pre-line;
        }

        .btn {
            background: #d63031; color: white; border: none;
            padding: 12px 30px; font-size: 1.1em; border-radius: 50px;
            cursor: pointer; transition: transform 0.2s; margin-top: 20px;
        }
        .btn:hover { background: #c0392b; transform: scale(1.05); }

        /* ç™»å½•åŒºåŸŸæ ·å¼ */
        .auth-section {
            margin-top: 25px;
            padding: 15px;
            background: #f1f2f6;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .github-login-btn {
            background: #24292e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            text-decoration: none;
        }
        .github-login-btn:hover { background: #444; }

        .user-info {
            display: none; /* é»˜è®¤éšè— */
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        .user-info img {
            width: 35px; height: 35px; border-radius: 50%;
            border: 2px solid #0984e3;
        }
        .user-name { font-weight: bold; color: #2d3436; }
        .logout-btn {
            font-size: 12px; color: #d63031; cursor: pointer;
            background: none; border: none; text-decoration: underline;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            margin-top: 15px;
            display: none; /* ç™»å½•åæ˜¾ç¤º */
            gap: 10px;
            width: 100%;
        }
        #danmaku-input {
            flex: 1; padding: 10px; border: 2px solid #fab1a0;
            border-radius: 20px; outline: none;
        }
        #send-btn {
            background: #0984e3; color: white; border: none;
            padding: 10px 20px; border-radius: 20px; cursor: pointer;
        }
        #send-btn:disabled { background: #b2bec3; cursor: not-allowed; }

        .status {
            margin-top: 10px; font-size: 12px; height: 20px;
        }
        .status.error { color: #d63031; }
        .status.success { color: #00b894; }
        .status.loading { color: #0984e3; }

        .footer { margin-top: 20px; font-size: 0.9em; color: #636e72; }
    </style>
</head>
<body>

    <div id="danmaku-container"></div>

    <div class="container">
        <h1>ğŸ é©¬å¹´å¤§å‰ ğŸ</h1>
        <div class="year">2026 ğŸ§§ ğŸ® ğŸŠ</div>
        
        <div class="blessing">
<strong>ğŸ é©¬å¹´é©¾åˆ°ï¼ŒAI åŠ æŒï¼</strong>
èµµå®‡åœ¨è¿™é‡Œç¥æ‚¨ï¼š
AI åˆ†çç¢ï¼Œé—²æ—¶ä¼´å®¶äººã€‚
æ™ºèƒ½å¯æ¢¦æƒ³ï¼Œåˆ›æ„ä»»é©°é£ã€‚
äººæœºå…±åä½œï¼Œæ™ºå¼•å‘ä¹¾å¤ï¼
        </div>

        <button class="btn" onclick="alert('ç¥æ‚¨é©¬å¹´è¡Œå¤§è¿ Â· ä¸‡äº‹çš†å¦‚æ„ï¼âœ¨')">ğŸ æ¥æ”¶ç¥ç¦</button>

        <!-- è®¤è¯ä¸å‘é€åŒºåŸŸ -->
        <div class="auth-section">
            <!-- æœªç™»å½•çŠ¶æ€ -->
            <div id="login-view">
                <p style="margin: 0 0 10px 0; font-size: 14px; color: #636e72;">
                    ğŸ’¬ å‘é€å¼¹å¹•å‰è¯·å…ˆç™»å½• GitHub
                </p>
                <button class="github-login-btn" onclick="loginWithGitHub()">
                    <svg height="20" viewBox="0 0 16 16" version="1.1" width="20" aria-hidden="true"><path fill="white" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                    ä½¿ç”¨ GitHub ç™»å½•
                </button>
            </div>

            <!-- å·²ç™»å½•çŠ¶æ€ -->
            <div id="logged-in-view" class="user-info">
                <img id="user-avatar" src="" alt="Avatar">
                <span class="user-name" id="user-name">User</span>
                <button class="logout-btn" onclick="logout()">é€€å‡º</button>
                
                <div class="input-area" style="display: flex;">
                    <input type="text" id="danmaku-input" placeholder="å†™ä¸‹ä½ çš„é©¬å¹´ç¥ç¦ (é™50å­—)..." maxlength="50">
                    <button id="send-btn" onclick="sendDanmaku()">å‘é€</button>
                </div>
            </div>
            
            <div class="status" id="status"></div>
        </div>

        <div class="footer">
            âœ¨ 2026 å†œå†é©¬å¹´ âœ¨<br>
            <small>å¼¹å¹•å°†ä½œä¸º Issue å­˜å‚¨åœ¨ä»“åº“ä¸­</small>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ (å¿…é¡»ä¿®æ”¹) =================
        const CONFIG = {
            // æ‚¨çš„ GitHub ç”¨æˆ·å
            owner: 'kudou1994', 
            // æ‚¨çš„ä»“åº“å
            repo: 'kudou.github.io',
            // ç”¨äºæ ‡è¯†å¼¹å¹•çš„ Label
            label: 'danmaku',
            // OAuth App çš„ Client ID (å¦‚æœæ²¡æœ‰ï¼Œè§ä¸‹æ–¹è¯´æ˜ï¼Œå¯å…ˆç”¨å…¬å…±æµ‹è¯•æˆ–è·³è¿‡éªŒè¯æ­¥éª¤)
            // âš ï¸ æ³¨æ„ï¼šä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œè¿™é‡Œä½¿ç”¨ä¸€ç§æ— éœ€åç«¯å›è°ƒçš„ç®€æ˜“æ¨¡å¼
            // å¦‚æœæ‚¨æ²¡æœ‰æ³¨å†Œ OAuth Appï¼Œç”¨æˆ·ç™»å½•å°†æ— æ³•è‡ªåŠ¨è·³å›ã€‚
            // å»ºè®®ï¼šæš‚æ—¶ä»…ä½œä¸ºæ¼”ç¤ºï¼Œæˆ–ä½¿ç”¨ Personal Token ç¡¬ç¼–ç ï¼ˆä¸æ¨èå…¬å¼€ï¼‰
            // æ­¤å¤„æˆ‘ä»¬é‡‡ç”¨ "URL Hash Token" æ¨¡å¼ï¼Œéœ€è¦ç”¨æˆ·åœ¨ GitHub è®¾ç½®é‡Œç”Ÿæˆ Token ç²˜è´´ï¼Ÿ
            // ä¸ï¼Œå¤ªå¤æ‚ã€‚æˆ‘ä»¬é‡‡ç”¨æœ€é€šç”¨çš„ï¼šå¼•å¯¼ç”¨æˆ·å»ç”Ÿæˆ Token å¹¶ç²˜è´´ï¼Œæˆ–è€…ä½¿ç”¨ OAuth Flowã€‚
            
            // ã€é‡è¦ã€‘ä¸ºäº†æœ€ç®€å•å®ç°ï¼Œæˆ‘ä»¬è®©ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ Token æˆ–è€…ä½¿ç”¨ OAuth è·³è½¬ã€‚
            // ä¸‹é¢å®ç°çš„æ˜¯ï¼šç‚¹å‡»ç™»å½• -> è·³è½¬ GitHub -> ç”¨æˆ·æˆæƒ -> è·³å›æœ¬é¡µ -> æå– Token
            // è¿™éœ€è¦æ‚¨åœ¨ GitHub åˆ›å»ºä¸€ä¸ª OAuth Appã€‚
            clientId: 'Ov23liuXYxHOmaUSKNUx', 
            // å›è°ƒåœ°å€ï¼šå¿…é¡»æ˜¯æ‚¨éƒ¨ç½²åçš„ GitHub Pages åœ°å€ï¼Œä¾‹å¦‚ï¼š
            // https://yourname.github.io/your-repo/
            redirectUri: 'https://kudou1994.github.io/kudou.github.io/' 
        };
        // =====================================================

        // åˆå§‹åŒ–å¼¹å¹•
        const container = document.getElementById('danmaku-container');
        const danmaku = new Danmaku({
            container: container,
            speed: 6,
            opacity: 0.9,
            fontSize: 18,
            color: '#ffffff',
            borderColor: '#000000',
            zIndex: 9999,
            data: []
        });

        let userToken = localStorage.getItem('gh_token');
        let userInfo = JSON.parse(localStorage.getItem('gh_user') || 'null');

        const loginView = document.getElementById('login-view');
        const loggedInView = document.getElementById('logged-in-view');
        const statusEl = document.getElementById('status');
        const sendBtn = document.getElementById('send-btn');
        const inputEl = document.getElementById('danmaku-input');

        // æ£€æŸ¥ URL ä¸­æ˜¯å¦æœ‰ Token (OAuth å›è°ƒ)
        function checkUrlForToken() {
            const hash = window.location.hash;
            if (hash && hash.includes('access_token=')) {
                const params = new URLSearchParams(hash.substring(1));
                const token = params.get('access_token');
                if (token) {
                    handleLoginSuccess(token);
                    // æ¸…ç† URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        // ç™»å½•å‡½æ•°
        function loginWithGitHub() {
            if (CONFIG.clientId === 'æ‚¨çš„ OAuth Client ID') {
                alert('âš ï¸ é…ç½®ç¼ºå¤±ï¼š\nè¯·åœ¨ä»£ç ä¸­é…ç½®æ‚¨çš„ GitHub OAuth Client IDã€‚\n\næ­¥éª¤ï¼š\n1. è®¿é—® https://github.com/settings/applications/new\n2. åˆ›å»ºæ–°åº”ç”¨\n3. Authorization callback URL å¡«å†™æœ¬é¡µé¢å®Œæ•´ç½‘å€\n4. å¤åˆ¶ Client ID å¡«å…¥ä»£ç ');
                return;
            }

            const scope = 'public_repo';
            const url = `https://github.com/login/oauth/authorize?client_id=${CONFIG.clientId}&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}&scope=${scope}`;
            window.location.href = url;
        }

        // å¤„ç†ç™»å½•æˆåŠŸ
        async function handleLoginSuccess(token) {
            userToken = token;
            localStorage.setItem('gh_token', token);
            showStatus('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...', 'success');
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (!response.ok) throw new Error('Failed to fetch user');
                const user = await response.json();
                
                userInfo = user;
                localStorage.setItem('gh_user', JSON.stringify(user));
                updateUI(true);
                showStatus(`æ¬¢è¿å›æ¥ï¼Œ${user.login}ï¼`, 'success');
                loadExistingDanmaku(); // åŠ è½½å†å²å¼¹å¹•
            } catch (e) {
                console.error(e);
                showStatus('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
                logout();
            }
        }

        // æ›´æ–° UI
        function updateUI(isLoggedIn) {
            if (isLoggedIn && userInfo) {
                loginView.style.display = 'none';
                loggedInView.style.display = 'flex';
                document.getElementById('user-avatar').src = userInfo.avatar_url;
                document.getElementById('user-name').textContent = userInfo.login;
                inputEl.disabled = false;
                sendBtn.disabled = false;
            } else {
                loginView.style.display = 'block';
                loggedInView.style.display = 'none';
                inputEl.disabled = true;
                sendBtn.disabled = true;
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('gh_token');
            localStorage.removeItem('gh_user');
            userToken = null;
            userInfo = null;
            updateUI(false);
            showStatus('å·²é€€å‡ºç™»å½•', '');
        }

        // å‘é€å¼¹å¹•
        async function sendDanmaku() {
            const text = inputEl.value.trim();
            if (!text) return alert('è¯·è¾“å…¥å†…å®¹');
            if (!userToken) return alert('æœªç™»å½•');

            sendBtn.disabled = true;
            showStatus('å‘é€ä¸­...', 'loading');

            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/issues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${userToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: text,
                        labels: [CONFIG.label],
                        body: `æ¥è‡ª ${userInfo.login} çš„é©¬å¹´ç¥ç¦\næ—¶é—´ï¼š${new Date().toLocaleString()}`
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message);
                }

                // å‘é€æˆåŠŸï¼Œæœ¬åœ°æ˜¾ç¤º
                danmaku.push({
                    text: text,
                    color: '#ffd700',
                    mode: 'rtl'
                });
                
                inputEl.value = '';
                showStatus('å‘é€æˆåŠŸï¼ğŸ‰', 'success');
                setTimeout(() => showStatus('', ''), 3000);

            } catch (e) {
                console.error(e);
                showStatus('å‘é€å¤±è´¥ï¼š' + e.message, 'error');
            } finally {
                sendBtn.disabled = false;
            }
        }

        // åŠ è½½ç°æœ‰å¼¹å¹• (Issues)
        async function loadExistingDanmaku() {
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/issues?labels=${CONFIG.label}&state=open&per_page=50`);
                if (!res.ok) return;
                const issues = await res.json();
                
                issues.forEach((issue, index) => {
                    setTimeout(() => {
                        danmaku.push({
                            text: issue.title,
                            color: getRandomColor(),
                            mode: 'rtl'
                        });
                    }, index * 800);
                });
            } catch (e) {
                console.error('åŠ è½½å†å²å¼¹å¹•å¤±è´¥', e);
            }
        }

        function getRandomColor() {
            const colors = ['#ff7675', '#74b9ff', '#55efc4', '#a29bfe', '#fd79a8', '#ffeaa7'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function showStatus(msg, type) {
            statusEl.textContent = msg;
            statusEl.className = 'status ' + type;
        }

        // åˆå§‹åŒ–
        window.onload = () => {
            checkUrlForToken();
            if (userToken && userInfo) {
                updateUI(true);
                loadExistingDanmaku();
            } else {
                updateUI(false);
            }
            
            // å›è½¦å‘é€
            inputEl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendDanmaku();
            });
        };
    </script>
</body>
</html>
